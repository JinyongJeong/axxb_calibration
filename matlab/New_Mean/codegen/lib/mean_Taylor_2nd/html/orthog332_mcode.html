<pre class="code">
<span class="srcline"><span class="lineno"><a href="114,1" id="srcline1"> 1</a></span><span class="line"><span class="comment">% This function takes in a 4 by 4 matrix which has the form of</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% [3 by 4; 0 0 0 n] and return a rigig transformation matrix by</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% orthogonalizing the upper left 3 by 3 matrix into a rotation matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="114,5" id="srcline5"> 5</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T4U3">T</span> = orthog(<span class="var type1" id="S3T4U6">M_hat</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="114,6" id="srcline6"> 6</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="114,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo " id="T2:U3"><span class="var type1" id="S4T2U9">opt</span> = <span class="mxinfo " id="T2:U5">2</span></span>;   <span class="comment">% opt = 1: Orthogonalize only the rotation part of M_hat </span></span></span>
<span class="srcline"><span class="lineno"><a href="114,8" id="srcline8"> 8</a></span><span class="line">           <span class="comment">% opt = 2: SVD the whole M_hat to obtain a transformation matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,9" id="srcline9"> 9</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S4T2U14">opt</span> == 1</span></span>
<span class="srcline"><span class="lineno"><a href="114,10" id="srcline10">10</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,11" id="srcline11">11</a></span><span class="line">    <span class="var type0" id="S5T0U18">R_hat</span> = <span class="var type0" id="S3T0U20">M_hat</span>(1:3,1:3); <span class="comment">% Note that R_hat doesn't belong to SO(3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,12" id="srcline12">12</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,13" id="srcline13">13</a></span><span class="line">    <span class="comment">% Project onto SO(3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,14" id="srcline14">14</a></span><span class="line">    <span class="var type0" id="S6T0U29">Rx</span> = <span class="var type0" id="S5T0U31">R_hat</span>*(<span class="var type0" id="S5T0U36">R_hat</span>'*<span class="var type0" id="S5T0U37">R_hat</span>)^(-1/2);</span></span>
<span class="srcline"><span class="lineno"><a href="114,15" id="srcline15">15</a></span><span class="line">    <span class="var type0" id="S6T0U45">Rx</span> = sign(det(<span class="var type0" id="S6T0U52">Rx</span>))/abs(det(<span class="var type0" id="S6T0U58">Rx</span>))^(1/3)*<span class="var type0" id="S6T0U63">Rx</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="114,16" id="srcline16">16</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,17" id="srcline17">17</a></span><span class="line">    <span class="var type0" id="S2T0U66">T</span> = [<span class="var type0" id="S6T0U69">Rx</span> <span class="var type0" id="S3T0U71">M_hat</span>(1:3,4); 0 0 0 1];</span></span>
<span class="srcline"><span class="lineno"><a href="114,18" id="srcline18">18</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,19" id="srcline19">19</a></span><span class="line"><span class="keyword">elseif</span> <span class="var type1" id="S4T2U83">opt</span> == 2</span></span>
<span class="srcline"><span class="lineno"><a href="114,20" id="srcline20">20</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,21" id="srcline21">21</a></span><span class="line">    [<span class="mxinfo " id="T5:U8"><span class="var type1" id="S10T5U88">U</span></span>, <span class="mxinfo " id="T2:U10"><span class="mxinfo " id="T2:U11">~</span></span>, <span class="mxinfo " id="T5:U12"><span class="var type1" id="S11T5U90">V</span></span>] = svd(<span class="mxinfo " id="T5:U14"><span class="var type1" id="S3T4U94">M_hat</span>(<span class="mxinfo " id="T55:U16">1:3</span>,<span class="mxinfo " id="T55:U17">1:3</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="114,22" id="srcline22">22</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,23" id="srcline23">23</a></span><span class="line">    <span class="comment">% The order of V and U might be flipped </span></span></span>
<span class="srcline"><span class="lineno"><a href="114,24" id="srcline24">24</a></span><span class="line">    <span class="mxinfo " id="T5:U18"><span class="var type1" id="S6T5U103">Rx</span> = <span class="mxinfo " id="T5:U20"><span class="var type1" id="S10T5U105">U</span>*<span class="mxinfo " id="T5:U22"><span class="var type1" id="S11T5U107">V</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="114,25" id="srcline25">25</a></span><span class="line"><span class="comment">%     Rx = V*U';</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,26" id="srcline26">26</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,27" id="srcline27">27</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T3:U24"><span class="mxinfo " id="T2:U25">det(<span class="var type1" id="S6T5U113">Rx</span>)</span> &lt; <span class="mxinfo " id="T2:U27">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="114,28" id="srcline28">28</a></span><span class="line">        <span class="mxinfo " id="T23:U28"><span class="mxinfo " id="T23:U29"><span class="var type1" id="S6T5U118">Rx</span>(<span class="mxinfo " id="T55:U31">:</span>,<span class="mxinfo " id="T2:U32">3</span>)</span> = <span class="mxinfo " id="T23:U33">- <span class="mxinfo " id="T23:U34"><span class="var type1" id="S6T5U123">Rx</span>(<span class="mxinfo " id="T55:U36">:</span>,<span class="mxinfo " id="T2:U37">3</span>)</span></span></span>;  </span></span>
<span class="srcline"><span class="lineno"><a href="114,29" id="srcline29">29</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,30" id="srcline30">30</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,31" id="srcline31">31</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T3:U38"><span class="mxinfo " id="T2:U39">abs( <span class="mxinfo " id="T2:U40"><span class="mxinfo " id="T2:U41">det(<span class="var type1" id="S6T5U134">Rx</span>)</span> - <span class="mxinfo " id="T2:U43">1</span></span>)</span> &gt; <span class="mxinfo " id="T2:U44"><span class="mxinfo " id="T2:U45">10</span>^-8</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="114,32" id="srcline32">32</a></span><span class="line">        fprintf(<span class="string">'A non rotation matrix is returned'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="114,33" id="srcline33">33</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,34" id="srcline34">34</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="114,35" id="srcline35">35</a></span><span class="line">    <span class="mxinfo " id="T4:U46"><span class="var type1" id="S2T4U146">T</span> = <span class="mxinfo " id="T4:U48">[<span class="mxinfo " id="T59:U49"><span class="var type1" id="S6T5U149">Rx</span> <span class="mxinfo " id="T23:U51"><span class="var type1" id="S3T4U151">M_hat</span>(<span class="mxinfo " id="T60:U53"><span class="mxinfo " id="T2:U54">1</span>:<span class="mxinfo " id="T2:U55">3</span></span>,<span class="mxinfo " id="T2:U56">4</span>)</span></span>; <span class="mxinfo " id="T53:U57"><span class="mxinfo " id="T2:U58">0</span> <span class="mxinfo " id="T2:U59">0</span> <span class="mxinfo " id="T2:U60">0</span> <span class="mxinfo " id="T2:U61">1</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="114,36" id="srcline36">36</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="114,37" id="srcline37">37</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="114,38" id="srcline38">38</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
