% This main fucntion compares with three Batch methods with three 
% corresponding definition (representations) of mean
% 
clear; 
clc; 
close all;

%% Add file dependencies
addpath ../../../rvctools/robot
addpath ../../../rvctools/common
addpath ../../../kinematics/kinematics/lie_group
addpath ../../../axxb_calibration/matlab/new_mean/codegen/mex/distibutionPropsMex

%% Initialize Parameters
num = 50; % Number of steps

gmean = [0;0;0;0;0;0];	%Gaussian Noise Mean

cov = 0.01*eye(6,6);

nstd = 0; % Gaussian Noise standard deviation Range

n_trials = 30; %60

x = randn(6,1); x = x./norm(x); X = expm(se3_vec(x)); % Generate a Random X

skip = 10; %10;

perm_rate = 0:skip:100;

n_rate = length(perm_rate);

%% Initialize error containers
Roterror_batch_all = zeros(n_trials, n_rate);
Roterror_kron_all = zeros(n_trials, n_rate);
Roterror_kron_2_all = zeros(n_trials, n_rate);

Tranerror_batch_all = zeros(n_trials, n_rate);
Tranerror_kron_all = zeros(n_trials, n_rate);
Tranerror_kron_2_all = zeros(n_trials, n_rate);

t_Error_avg = [];

%% Computation Loops
A_noise = [];
A_mean = zeros(4,4,3);
B_mean = zeros(4,4,3);

B = [];
j = 0;
opt = 2;
optPDF = 3; % select the distribution for A and B
optNoise = true;

for j = 1:n_rate
    
    t_Error = [];
    
    for k = 1:n_trials
        
        [A, B] = generateAB(num, 4, X, gmean, cov);
        [A1, B1] = generateAB(num, optPDF, X, gmean, cov);
        [A2, B2] = generateAB(num, optPDF, X, gmean, cov);
        
        if optNoise
            B = sensorNoise(B, M, Sig(1), 1);
        
        % PA=randperm(size(A,3));
        % PB=randperm(size(B,3));
        
        % waitbar((j*k)/(100*trials))
        
        PA = (1:size(A,3));
        PB = (1:size(B,3));
        
        for i = 1:length(PA)
            if rand <= 0.01*perm_rate(j)
                index = randi(num,1);
                PA([i index]) = PA([index i]);
            end
        end
        
        A_perm = A(:, :, PA);
        B_perm = B(:, :, PB);
        
        [X_batch, MA, MB] = batchSolve(A_perm, B_perm); %batchSolveNew(A_perm, B_perm, 5); %
        
        [A_mean(:,:,1), SigA] = getMeanCov(A);
        [A_mean(:,:,2), SigA1] = getMeanCov(A1);
        [A_mean(:,:,3), SigA2] = getMeanCov(A2);
        [B_mean(:,:,1), SigB] = getMeanCov(B);
        [B_mean(:,:,2), SigB1] = getMeanCov(B1);
        [B_mean(:,:,3), SigB2] = getMeanCov(B2);
        
        [X_kron] = axb_KronSolve(A_mean, B_mean); %
        [X_kron_2] = axb_KronSolve(A_perm, B_perm); %
        
        %% Store Errors
        Roterror_batch_all(k,j) = roterror(X_batch, X);
        Roterror_kron_all(k, j) = roterror(X_kron, X);
        Roterror_kron_2_all(k, j) = roterror(X_kron_2, X);
        
        Tranerror_batch_all(k,j) = tranerror(X_batch, X);
        Tranerror_kron_all(k, j) = tranerror(X_kron,X);
        Tranerror_kron_2_all(k, j) = tranerror(X_kron_2,X);
                
    end    
end

%%
Roterror_batch_avg = mean(Roterror_batch_all);
Roterror_kron_avg = mean(Roterror_kron_all);
Roterror_kron_2_avg = mean(Roterror_kron_2_all);

Tranerror_batch_avg = mean(Tranerror_batch_all);
Tranerror_kron_avg = mean(Tranerror_kron_all);
Tranerror_kron_2_avg = mean(Tranerror_kron_2_all);

%%
figure
scatter((0:skip:100), Roterror_batch_avg, '+');
hold on
scatter((0:skip:100), Roterror_kron_avg, '^');
% hold on
scatter((0:skip:100), Roterror_kron_2_avg, '*');
hold off
xlabel('Percentage of scrambling in the A and B sets')
ylabel('Rotation error of X')
legend('Batch Method', 'Kronecker Product', 'Kronecker Product 2', 'Location', 'SouthOutside')
% axis([0 100 0 4])

figure
scatter((0:skip:100), Tranerror_batch_avg, '+');
hold on
scatter((0:skip:100), Tranerror_kron_avg,'^');
% hold on
scatter((0:skip:100), Tranerror_kron_2_avg,'*');
hold off
xlabel('Percentage of scrambling in the A and B sets')
ylabel('Translation error of X')
legend('Batch Method', 'Kronecker Product', 'Kronecker Product 2', 'Location', 'SouthOutside')
% axis([0 100 0 0.5])
